<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NMR Data Analysis Tutorial • ggforestplot</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="NMR Data Analysis Tutorial">
<meta property="og:description" content="">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ggforestplot</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
<li>
  <a href="https://nightingalehealth.com">Nightingale Health</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://twitter.com/NgaleHealth">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/nightingalehealth">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>NMR Data Analysis Tutorial</h1>
                        <h4 class="author">Nightingale Health Ltd.</h4>
            
            <h4 class="date">2019-03-05</h4>
      
      
      <div class="hidden name"><code>nmr-data-analysis-tutorial.Rmd</code></div>

    </div>

    
    
<div id="overview" class="section level2">
<h2 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h2>
<p>In this tutorial we will go through the basic steps of importing blood metabolomics data into R, joining them with phenotypes or endpoint data, and performing basic epidimiological analysis. The tutorial uses simulated demo datasets from <a href="https://nightingalehealth.com/technology">Nightingale’s NMR platform</a>.</p>
</div>
<div id="prerequisites" class="section level2">
<h2 class="hasAnchor">
<a href="#prerequisites" class="anchor"></a>Prerequisites</h2>
<p>This tutorial uses R, which is free, compiles and runs in most operating systems. If you don’t have it already installed in your system, you may install it by following the instructions <a href="https://www.r-project.org/">here</a>. Additionally, we recommend using the RStudio IDE (Integrated Development Environment), which can be downloaded and installed following the instructions <a href="https://www.rstudio.com/products/rstudio/download/">here</a> for the free “RStudio Desktop (Open Source License)”.</p>
<p>You should be able to reproduce easily the code in this tutorial, even with very little knowledge in programming. If you have never programmed in R before and are intrested to learn more, you may find the following book useful, <a href="https://rstudio-education.github.io/hopr/">Hands on Programming with R</a> by Garrett Grolemund.</p>
<p>Throughout the tutorial, we will be using the collection of <a href="https://www.tidyverse.org/"><code>tidyverse</code> R packages</a> and try to abide by their philosophy. You can install the complete tidyverse by typing the following line of code in the R console:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Install the tidyverse packages</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/install.packages">install.packages</a></span>(tidyverse)

<span class="co"># Attach the tidyverse packages into the current session</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tidyverse)</code></pre></div>
<p>We also note the usage of the pipe <code>%&gt;%</code> symbol throughout the code of this tutorial. The pipe is a way to write a series of operations on an R object, e.g. a dataset, in an easy-to-read way. As an example, the operation <code>x %&gt;% f(y)</code> effectivly means <code>f(x, y)</code>. You can read more on the pipe <a href="https://cran.r-project.org/web/packages/magrittr/vignettes/magrittr.html">here</a>.</p>
</div>
<div id="overview-of-nightingale-blood-biomarker-data" class="section level2">
<h2 class="hasAnchor">
<a href="#overview-of-nightingale-blood-biomarker-data" class="anchor"></a>Overview of Nightingale blood biomarker data</h2>
<p>The NMR biomarker concentrations are provided in xlsx, csv and tsv formats. R can read either but in this tutorial we will use the csv format.</p>
<p>For the purposes of this tutorial we will use an example csv file. Download the zipped folder <a href="https://github.com/NightingaleHealth/ggforestplot/blob/master/data-raw/metabolomics_data.zip">here</a> and unzip it. It contains two files, one with metabolomics data and one with corresponding clinical data that we will use later on.</p>
<p>Type the commands below in your R session to load the metabolomics data and view the available biomarkers. Mind to put the correct path in the <code>file</code> parameter below.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Read the biomarker concentration file</span>
df_nmr_results &lt;-<span class="st"> </span>readr<span class="op">::</span><span class="kw"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span>(
  <span class="co"># Enter the correct location for your file below</span>
  <span class="dt">file =</span> <span class="st">"/path/to/file/12345-Results.csv"</span>,
  <span class="co"># Set not only NA but TAG string as &lt;NA&gt; </span>
  <span class="dt">na =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"NA"</span>, <span class="st">"TAG"</span>), 
  <span class="dt">col_types =</span> <span class="kw">cols</span>(<span class="dt">.default =</span> <span class="kw">col_double</span>(), 
                   <span class="dt">Sample_id =</span> <span class="kw">col_character</span>())
)</code></pre></div>
<p>Print the names of all the variables in the dataset for inspection.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(df_nmr_results)
<span class="co">#&gt;   [1] "Sample_id"                       "EDTA_plasma"                    </span>
<span class="co">#&gt;   [3] "Citrate_plasma"                  "Ethanol"                        </span>
<span class="co">#&gt;   [5] "Isopropyl_alcohol"               "N_methyl_2_pyrrolidone"         </span>
<span class="co">#&gt;   [7] "Polysaccharides"                 "Aminocaproic_acid"              </span>
<span class="co">#&gt;   [9] "Low_glucose"                     "High_lactate"                   </span>
<span class="co">#&gt;  [11] "High_pyruvate"                   "Low_glutamine_or_high_glutamate"</span>
<span class="co">#&gt;  [13] "Gluconolactone"                  "Diluted_sample"                 </span>
<span class="co">#&gt;  [15] "Unexpected_amino_acid_signals"   "Unidentified_macromolecules"    </span>
<span class="co">#&gt;  [17] "Unidentified_small_molecule_a"   "Unidentified_small_molecule_b"  </span>
<span class="co">#&gt;  [19] "Unidentified_small_molecule_c"   "Total_C"                        </span>
<span class="co">#&gt;  [21] "VLDL_C"                          "Remnant_C"                      </span>
<span class="co">#&gt;  [23] "LDL_C"                           "HDL_C"                          </span>
<span class="co">#&gt;  [25] "HDL2_C"                          "HDL3_C"                         </span>
<span class="co">#&gt;  [27] "Esterified_C"                    "Free_C"                         </span>
<span class="co">#&gt;  [29] "Total_TG"                        "VLDL_TG"                        </span>
<span class="co">#&gt;  [31] "LDL_TG"                          "HDL_TG"                         </span>
<span class="co">#&gt;  [33] "Phosphoglyc"                     "TG_by_PG"                       </span>
<span class="co">#&gt;  [35] "Cholines"                        "Phosphatidylc"                  </span>
<span class="co">#&gt;  [37] "Sphingomyelins"                  "ApoB"                           </span>
<span class="co">#&gt;  [39] "ApoA1"                           "ApoB_by_ApoA1"                  </span>
<span class="co">#&gt;  [41] "Total_FA"                        "Unsaturation"                   </span>
<span class="co">#&gt;  [43] "Omega_3"                         "Omega_6"                        </span>
<span class="co">#&gt;  [45] "PUFA"                            "MUFA"                           </span>
<span class="co">#&gt;  [47] "SFA"                             "LA"                             </span>
<span class="co">#&gt;  [49] "DHA"                             "Omega_3_pct"                    </span>
<span class="co">#&gt;  [51] "Omega_6_pct"                     "PUFA_pct"                       </span>
<span class="co">#&gt;  [53] "MUFA_pct"                        "SFA_pct"                        </span>
<span class="co">#&gt;  [55] "LA_pct"                          "DHA_pct"                        </span>
<span class="co">#&gt;  [57] "Ala"                             "Gln"                            </span>
<span class="co">#&gt;  [59] "Gly"                             "His"                            </span>
<span class="co">#&gt;  [61] "Ile"                             "Leu"                            </span>
<span class="co">#&gt;  [63] "Val"                             "Phe"                            </span>
<span class="co">#&gt;  [65] "Tyr"                             "Glucose"                        </span>
<span class="co">#&gt;  [67] "Lactate"                         "Pyruvate"                       </span>
<span class="co">#&gt;  [69] "Citrate"                         "Glycerol"                       </span>
<span class="co">#&gt;  [71] "Acetate"                         "Acetoacetate"                   </span>
<span class="co">#&gt;  [73] "bOHbutyrate"                     "Creatinine"                     </span>
<span class="co">#&gt;  [75] "Albumin"                         "GlycA"                          </span>
<span class="co">#&gt;  [77] "XXL_VLDL_P"                      "XXL_VLDL_L"                     </span>
<span class="co">#&gt;  [79] "XXL_VLDL_PL"                     "XXL_VLDL_C"                     </span>
<span class="co">#&gt;  [81] "XXL_VLDL_CE"                     "XXL_VLDL_FC"                    </span>
<span class="co">#&gt;  [83] "XXL_VLDL_TG"                     "XL_VLDL_P"                      </span>
<span class="co">#&gt;  [85] "XL_VLDL_L"                       "XL_VLDL_PL"                     </span>
<span class="co">#&gt;  [87] "XL_VLDL_C"                       "XL_VLDL_CE"                     </span>
<span class="co">#&gt;  [89] "XL_VLDL_FC"                      "XL_VLDL_TG"                     </span>
<span class="co">#&gt;  [91] "L_VLDL_P"                        "L_VLDL_L"                       </span>
<span class="co">#&gt;  [93] "L_VLDL_PL"                       "L_VLDL_C"                       </span>
<span class="co">#&gt;  [95] "L_VLDL_CE"                       "L_VLDL_FC"                      </span>
<span class="co">#&gt;  [97] "L_VLDL_TG"                       "M_VLDL_P"                       </span>
<span class="co">#&gt;  [99] "M_VLDL_L"                        "M_VLDL_PL"                      </span>
<span class="co">#&gt; [101] "M_VLDL_C"                        "M_VLDL_CE"                      </span>
<span class="co">#&gt; [103] "M_VLDL_FC"                       "M_VLDL_TG"                      </span>
<span class="co">#&gt; [105] "S_VLDL_P"                        "S_VLDL_L"                       </span>
<span class="co">#&gt; [107] "S_VLDL_PL"                       "S_VLDL_C"                       </span>
<span class="co">#&gt; [109] "S_VLDL_CE"                       "S_VLDL_FC"                      </span>
<span class="co">#&gt; [111] "S_VLDL_TG"                       "XS_VLDL_P"                      </span>
<span class="co">#&gt; [113] "XS_VLDL_L"                       "XS_VLDL_PL"                     </span>
<span class="co">#&gt; [115] "XS_VLDL_C"                       "XS_VLDL_CE"                     </span>
<span class="co">#&gt; [117] "XS_VLDL_FC"                      "XS_VLDL_TG"                     </span>
<span class="co">#&gt; [119] "IDL_P"                           "IDL_L"                          </span>
<span class="co">#&gt; [121] "IDL_PL"                          "IDL_C"                          </span>
<span class="co">#&gt; [123] "IDL_CE"                          "IDL_FC"                         </span>
<span class="co">#&gt; [125] "IDL_TG"                          "L_LDL_P"                        </span>
<span class="co">#&gt; [127] "L_LDL_L"                         "L_LDL_PL"                       </span>
<span class="co">#&gt; [129] "L_LDL_C"                         "L_LDL_CE"                       </span>
<span class="co">#&gt; [131] "L_LDL_FC"                        "L_LDL_TG"                       </span>
<span class="co">#&gt; [133] "M_LDL_P"                         "M_LDL_L"                        </span>
<span class="co">#&gt; [135] "M_LDL_PL"                        "M_LDL_C"                        </span>
<span class="co">#&gt; [137] "M_LDL_CE"                        "M_LDL_FC"                       </span>
<span class="co">#&gt; [139] "M_LDL_TG"                        "S_LDL_P"                        </span>
<span class="co">#&gt; [141] "S_LDL_L"                         "S_LDL_PL"                       </span>
<span class="co">#&gt; [143] "S_LDL_C"                         "S_LDL_CE"                       </span>
<span class="co">#&gt; [145] "S_LDL_FC"                        "S_LDL_TG"                       </span>
<span class="co">#&gt; [147] "XL_HDL_P"                        "XL_HDL_L"                       </span>
<span class="co">#&gt; [149] "XL_HDL_PL"                       "XL_HDL_C"                       </span>
<span class="co">#&gt; [151] "XL_HDL_CE"                       "XL_HDL_FC"                      </span>
<span class="co">#&gt; [153] "XL_HDL_TG"                       "L_HDL_P"                        </span>
<span class="co">#&gt; [155] "L_HDL_L"                         "L_HDL_PL"                       </span>
<span class="co">#&gt; [157] "L_HDL_C"                         "L_HDL_CE"                       </span>
<span class="co">#&gt; [159] "L_HDL_FC"                        "L_HDL_TG"                       </span>
<span class="co">#&gt; [161] "M_HDL_P"                         "M_HDL_L"                        </span>
<span class="co">#&gt; [163] "M_HDL_PL"                        "M_HDL_C"                        </span>
<span class="co">#&gt; [165] "M_HDL_CE"                        "M_HDL_FC"                       </span>
<span class="co">#&gt; [167] "M_HDL_TG"                        "S_HDL_P"                        </span>
<span class="co">#&gt; [169] "S_HDL_L"                         "S_HDL_PL"                       </span>
<span class="co">#&gt; [171] "S_HDL_C"                         "S_HDL_CE"                       </span>
<span class="co">#&gt; [173] "S_HDL_FC"                        "S_HDL_TG"                       </span>
<span class="co">#&gt; [175] "VLDL_size"                       "LDL_size"                       </span>
<span class="co">#&gt; [177] "HDL_size"                        "XXL_VLDL_PL_pct"                </span>
<span class="co">#&gt; [179] "XXL_VLDL_C_pct"                  "XXL_VLDL_CE_pct"                </span>
<span class="co">#&gt; [181] "XXL_VLDL_FC_pct"                 "XXL_VLDL_TG_pct"                </span>
<span class="co">#&gt; [183] "XL_VLDL_PL_pct"                  "XL_VLDL_C_pct"                  </span>
<span class="co">#&gt; [185] "XL_VLDL_CE_pct"                  "XL_VLDL_FC_pct"                 </span>
<span class="co">#&gt; [187] "XL_VLDL_TG_pct"                  "L_VLDL_PL_pct"                  </span>
<span class="co">#&gt; [189] "L_VLDL_C_pct"                    "L_VLDL_CE_pct"                  </span>
<span class="co">#&gt; [191] "L_VLDL_FC_pct"                   "L_VLDL_TG_pct"                  </span>
<span class="co">#&gt; [193] "M_VLDL_PL_pct"                   "M_VLDL_C_pct"                   </span>
<span class="co">#&gt; [195] "M_VLDL_CE_pct"                   "M_VLDL_FC_pct"                  </span>
<span class="co">#&gt; [197] "M_VLDL_TG_pct"                   "S_VLDL_PL_pct"                  </span>
<span class="co">#&gt; [199] "S_VLDL_C_pct"                    "S_VLDL_CE_pct"                  </span>
<span class="co">#&gt; [201] "S_VLDL_FC_pct"                   "S_VLDL_TG_pct"                  </span>
<span class="co">#&gt; [203] "XS_VLDL_PL_pct"                  "XS_VLDL_C_pct"                  </span>
<span class="co">#&gt; [205] "XS_VLDL_CE_pct"                  "XS_VLDL_FC_pct"                 </span>
<span class="co">#&gt; [207] "XS_VLDL_TG_pct"                  "IDL_PL_pct"                     </span>
<span class="co">#&gt; [209] "IDL_C_pct"                       "IDL_CE_pct"                     </span>
<span class="co">#&gt; [211] "IDL_FC_pct"                      "IDL_TG_pct"                     </span>
<span class="co">#&gt; [213] "L_LDL_PL_pct"                    "L_LDL_C_pct"                    </span>
<span class="co">#&gt; [215] "L_LDL_CE_pct"                    "L_LDL_FC_pct"                   </span>
<span class="co">#&gt; [217] "L_LDL_TG_pct"                    "M_LDL_PL_pct"                   </span>
<span class="co">#&gt; [219] "M_LDL_C_pct"                     "M_LDL_CE_pct"                   </span>
<span class="co">#&gt; [221] "M_LDL_FC_pct"                    "M_LDL_TG_pct"                   </span>
<span class="co">#&gt; [223] "S_LDL_PL_pct"                    "S_LDL_C_pct"                    </span>
<span class="co">#&gt; [225] "S_LDL_CE_pct"                    "S_LDL_FC_pct"                   </span>
<span class="co">#&gt; [227] "S_LDL_TG_pct"                    "XL_HDL_PL_pct"                  </span>
<span class="co">#&gt; [229] "XL_HDL_C_pct"                    "XL_HDL_CE_pct"                  </span>
<span class="co">#&gt; [231] "XL_HDL_FC_pct"                   "XL_HDL_TG_pct"                  </span>
<span class="co">#&gt; [233] "L_HDL_PL_pct"                    "L_HDL_C_pct"                    </span>
<span class="co">#&gt; [235] "L_HDL_CE_pct"                    "L_HDL_FC_pct"                   </span>
<span class="co">#&gt; [237] "L_HDL_TG_pct"                    "M_HDL_PL_pct"                   </span>
<span class="co">#&gt; [239] "M_HDL_C_pct"                     "M_HDL_CE_pct"                   </span>
<span class="co">#&gt; [241] "M_HDL_FC_pct"                    "M_HDL_TG_pct"                   </span>
<span class="co">#&gt; [243] "S_HDL_PL_pct"                    "S_HDL_C_pct"                    </span>
<span class="co">#&gt; [245] "S_HDL_CE_pct"                    "S_HDL_FC_pct"                   </span>
<span class="co">#&gt; [247] "S_HDL_TG_pct"</span></code></pre></div>
<p>The first column, <code>Sample_id</code>, contains the sample identifiers. Columns 2 to 19 contain information on different tags that a sample may contain. Explanation on any tags present in an actual result file is given along with the analysis report but here all possible tag columns are provided for demonstarational purposes. The rest of the columns correspond to machine readable abbreviations of the NMR-quantified blood biomarkers.</p>
<p>Let us drop the tag columns as they are not used in this demo.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">df_nmr_results &lt;-<span class="st"> </span>
<span class="st">  </span>df_nmr_results <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co"># Make sure you ch</span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>(EDTA_plasma<span class="op">:</span>Unidentified_small_molecule_c))</code></pre></div>
<div id="rename-alternative-biomarker-names" class="section level3">
<h3 class="hasAnchor">
<a href="#rename-alternative-biomarker-names" class="anchor"></a>Rename alternative biomarker names</h3>
<p>If you have a Nightingale result file with alternative biomarker names, for example <code>XXL-VLDL-C_%</code> instead of <code>XXL_VLDL_C_pct</code> or <code>LA/FA</code> instead of <code>LA_pct</code>, you may utilize the variable <code>alternative_ids</code> in the <code><a href="../reference/df_NG_biomarker_metadata.html">ggforestplot::df_NG_biomarker_metadata</a></code> dataset to convert from one type to the other. An example is provided below, where we transform a dataset with alternative biomarker name (as long as they are found in the <code>ggforestplot::df_NG_biomarker_metadata$alternative_ids</code> list) to their <code>ggforestplot::df_NG_biomarker_metadata$machine_readable_name</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Assume that your data frame, containing alternative biomarker names, is called </span>
<span class="co"># df_nmr_results_alt_names</span>

alt_names &lt;-<span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(df_nmr_results_alt_names)

new_names &lt;-<span class="st"> </span>
<span class="st">  </span>alt_names <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span>purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map_chr</a></span>(<span class="cf">function</span>(id) {
    <span class="co"># Look through the alternative_ids</span>
    hits &lt;-
<span class="st">      </span>purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map_lgl</a></span>(
        df_NG_biomarker_metadata<span class="op">$</span>alternative_names,
        <span class="op">~</span><span class="st"> </span>id <span class="op">%in%</span><span class="st"> </span>.
      )

    <span class="co"># If one unambiguous hit, return it.</span>
    <span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(hits) <span class="op">==</span><span class="st"> </span>1L) {
      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(df_NG_biomarker_metadata<span class="op">$</span>machine_readable_name[hits])
      <span class="co"># If not found, give a warning and pass through the input.</span>
    } <span class="cf">else</span> {
      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/warning">warning</a></span>(<span class="st">"Biomarker not found: "</span>, id, <span class="dt">call. =</span> <span class="ot">FALSE</span>)
      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(id)
    } 
  })

<span class="co"># Name the vector with the new names  </span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(alt_names) &lt;-<span class="st"> </span>new_names

<span class="co"># Rename your result data frame with machine_readable_names </span>
df_nmr_results_alt_names &lt;-<span class="st"> </span>
<span class="st">  </span>df_nmr_results_alt_names <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">rename</span>(<span class="op">!!</span>alt_names)</code></pre></div>
</div>
</div>
<div id="association-analysis" class="section level2">
<h2 class="hasAnchor">
<a href="#association-analysis" class="anchor"></a>Association analysis</h2>
<div id="join-the-blood-biomarker-data-with-other-variables" class="section level3">
<h3 class="hasAnchor">
<a href="#join-the-blood-biomarker-data-with-other-variables" class="anchor"></a>Join the blood biomarker data with other variables</h3>
<p>Next we join the blood biomarker data above with other variables we may have, such as patient basic information (e.g. gender, age, e.t.c.) or patient outcomes (e.g. a disease event).</p>
<p>The second dataset you downloaded earlier (from <a href="https://github.com/NightingaleHealth/ggforestplot/blob/master/data-raw/metabolomics_data.zip">here</a>), called <code>clinical_data.csv</code>, has additional to the NMR information corresponding to the same fictional individuals. It has information on gender, age, body mass index (BMI) as well as incident T2D diabetes.</p>
<p>We will join the two datasets using the IDs, i.e. column <code>Sample_id</code> in the NMR data and column <code>identifier</code> in the clinical data. Except for the columns having different names in the two files, the IDs themselves are not the same either (which is also often the case in real life). <code>Sample_id</code> in the NMR is a character column with the prefix <code>ResearchInstitutionProjectLabId_</code> while <code>identifier</code> in clinical data is a character consisting of 4 numbers.</p>
<p>Below we read the clinical data and join the two datasets after a few adjustments.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Read the clinical_data.csv data file</span>
df_clinical_data &lt;-<span class="st"> </span>readr<span class="op">::</span><span class="kw"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span>(
  <span class="co"># Enter the correct location for your file below</span>
  <span class="dt">file =</span> <span class="st">"/path/to/file/clinical_data.csv"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># Rename the identifier column to Sample_id as in the NMR result file</span>
<span class="st">  </span><span class="kw">rename</span>(<span class="dt">Sample_id =</span> identifier) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co"># Harmonize the id entries in clinical data with the ids in the NMR data </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Sample_id =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(
    <span class="st">"ResearchInstitutionProjectLabId_"</span>, 
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(Sample_id)
  ))</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Inspect the first 10 entries</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(df_clinical_data)
<span class="co">#&gt; # A tibble: 1,887 x 6</span>
<span class="co">#&gt;    Sample_id     gender baseline_age   BMI incident_diabet… age_at_diabetes</span>
<span class="co">#&gt;    &lt;chr&gt;         &lt;chr&gt;         &lt;dbl&gt; &lt;dbl&gt;            &lt;dbl&gt;           &lt;dbl&gt;</span>
<span class="co">#&gt;  1 ResearchInst… male             50  27.2                0              57</span>
<span class="co">#&gt;  2 ResearchInst… female           49  35.1                0              66</span>
<span class="co">#&gt;  3 ResearchInst… female           59  24.6                0              79</span>
<span class="co">#&gt;  4 ResearchInst… male             69  26.3                0              80</span>
<span class="co">#&gt;  5 ResearchInst… female           59  27.9                0              71</span>
<span class="co">#&gt;  6 ResearchInst… male             64  29.0                0              74</span>
<span class="co">#&gt;  7 ResearchInst… female           43  22.2                0              59</span>
<span class="co">#&gt;  8 ResearchInst… female           34  24.7                0              53</span>
<span class="co">#&gt;  9 ResearchInst… female           46  29.3                0              63</span>
<span class="co">#&gt; 10 ResearchInst… male             55  31.7                0              78</span>
<span class="co">#&gt; # … with 1,877 more rows</span>

<span class="co"># Join NMR result file with the clinical data using column "Sample_id"</span>
df_full_data &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">left_join</a></span>(
  <span class="dt">x =</span> df_nmr_results,
  <span class="dt">y =</span> df_clinical_data,
  <span class="dt">by =</span> <span class="st">"Sample_id"</span>
)</code></pre></div>
</div>
<div id="linear-regression" class="section level3">
<h3 class="hasAnchor">
<a href="#linear-regression" class="anchor"></a>Linear regression</h3>
<p>We will first plot the distribution for a specific biomarker to inspect the data more closely. We choose glycoprotein acetyls (abbrev. GlycA) which reflects the amount of N-acetyl groups in circulating glycoproteins, many of which are involved in the acute-phase inflammatory response.</p>
<p>We first add a column to the dataset, marking the subjects as obese or not-obese. We then plot the GlycA distributions for the two sets as boxplots.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">df_full_data <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co"># Add a column to mark obese/non-obese subjects</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">obesity =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/ifelse">ifelse</a></span>(BMI <span class="op">&gt;=</span><span class="st"> </span><span class="dv">30</span>, <span class="dt">yes =</span> <span class="st">"Obese"</span>, <span class="dt">no =</span> <span class="st">"Not obese"</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co"># Filter out subjects with missing values (if any)</span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(<span class="op">!</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NA">is.na</a></span>(obesity)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co"># Box plots for each group</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">y =</span> GlycA, <span class="dt">x =</span> obesity, <span class="dt">color =</span> obesity)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_boxplot</span>() <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="co"># Remove x axis title </span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.title.x =</span> <span class="kw">element_blank</span>())</code></pre></div>
<div class="figure" style="text-align: center">
<img src="nmr-data-analysis-tutorial_files/figure-html/densityplot-1.png" alt="GlycA distribution for obese and not-obese subjects" width="672"><p class="caption">
GlycA distribution for obese and not-obese subjects
</p>
</div>
<p>In the box plot above, the lower, middle and higher hinges correspond to 25%, 50% and 75% quantiles, respectively. Therefore, we see that the GlycA distribution for obese subjects is clearly shifted to higher values as compared to non-obese subjects, indicating that this marker is likely positively associated with obesity.</p>
<p>We will now estimate associations of each biomarker to BMI via linear regression:</p>
<span class="math display">\[\begin{align*}
y = \beta * x + \alpha
\end{align*}\]</span>
<p>where the blood biomarker is the outcome, <span class="math inline">\(y\)</span>, and BMI is the exposure <span class="math inline">\(x\)</span>. The association of <span class="math inline">\(x\)</span> with <span class="math inline">\(y\)</span> refers to the beta coefficient (<span class="math inline">\(\beta\)</span>).</p>
<p>Below, we use function <code><a href="../reference/discovery_regression.html">ggforestplot::discovery_regression()</a></code>, with input parameter <code>model</code> set to <code>'lm'</code> to estimate multiple, adjusted, linear associations, for all the biomarkers. Note that we log tranform and scale the biomarkers so that the magnitude of associations are directly comparable across the different biomarkers. (Note: The log-transformation is not, strictly speaking, required here: the blood metabolites are in this case the outcome and not the exposure, while log-tranformation is done in order to satisfy the assumption of linear regression for normal distribution of the residuals.)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Extract names of NMR biomarkers</span>
nmr_biomarkers &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(df_full_data)[<span class="dv">2</span><span class="op">:</span><span class="dv">229</span>]

<span class="co"># Select only variables to be used for the model and collapse to a long data </span>
<span class="co"># format</span>
df_long &lt;-
<span class="st">  </span>df_full_data <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># Select only model variables</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(nmr_biomarkers, gender, baseline_age, BMI) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># log-tranform biomarkers</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_at</a></span>(<span class="dt">.vars =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(nmr_biomarkers), <span class="dt">.funs =</span> dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/funs.html">funs</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">log1p</a></span>(.))) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># Scale biomarkers</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_at</a></span>(<span class="dt">.vars =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(nmr_biomarkers), <span class="dt">.funs =</span> dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/funs.html">funs</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/scale">scale</a></span>(.)))) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># Collapse to a long data format</span>
<span class="st">  </span>tidyr<span class="op">::</span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/gather.html">gather</a></span>(<span class="dt">key =</span> biomarkerid, <span class="dt">value =</span> biomarkervalue, nmr_biomarkers)
<span class="co">#&gt; Warning: funs() is soft deprecated as of dplyr 0.8.0</span>
<span class="co">#&gt; please use list() instead</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; # Before:</span>
<span class="co">#&gt; funs(name = f(.)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; # After: </span>
<span class="co">#&gt; list(name = ~f(.))</span>
<span class="co">#&gt; This warning is displayed once per session.</span>

<span class="co"># Estimate sex- and age-adjusted associations of metabolite to BMI</span>
df_assoc_per_biomarker_bmi &lt;-
<span class="st">  </span>ggforestplot<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggforestplot/topics/discovery_regression">discovery_regression</a></span>(
    <span class="dt">df_long =</span> df_long,
    <span class="dt">model =</span> <span class="st">"lm"</span>,
    <span class="dt">formula =</span>
      <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/formula">formula</a></span>(
       biomarkervalue <span class="op">~</span><span class="st"> </span>BMI <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">factor</a></span>(gender) <span class="op">+</span><span class="st"> </span>baseline_age
      ),
    <span class="dt">key =</span> biomarkerid,
    <span class="dt">predictor =</span> BMI
  ) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co"># Join this dataset with the grouping data in order to choose a different </span>
<span class="st">  </span><span class="co"># biomarker naming option</span>
<span class="st">  </span><span class="kw">left_join</span>(
    <span class="kw">select</span>(
      df_NG_biomarker_metadata, 
      name,
      <span class="dt">biomarkerid =</span> machine_readable_name
    ), 
    <span class="dt">by =</span> <span class="st">"biomarkerid"</span>)

<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(df_assoc_per_biomarker_bmi)
<span class="co">#&gt; # A tibble: 6 x 5</span>
<span class="co">#&gt;   biomarkerid estimate      se   pvalue name     </span>
<span class="co">#&gt;   &lt;chr&gt;          &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;    </span>
<span class="co">#&gt; 1 Total_C       0.0165 0.00532 1.97e- 3 Total-C  </span>
<span class="co">#&gt; 2 VLDL_C        0.0498 0.00508 3.24e-22 VLDL-C   </span>
<span class="co">#&gt; 3 Remnant_C     0.0377 0.00519 6.10e-13 Remnant-C</span>
<span class="co">#&gt; 4 LDL_C         0.0245 0.00532 4.18e- 6 LDL-C    </span>
<span class="co">#&gt; 5 HDL_C        -0.0415 0.00485 2.45e-17 HDL-C    </span>
<span class="co">#&gt; 6 HDL2_C       -0.0460 0.00480 2.65e-21 HDL2-C</span></code></pre></div>
<p>The data frame <code>df_assoc_per_biomarker_bmi</code> above, contains 228 rows, one for each blood biomarker, and 5 variables (columns): the <code>biomarkerid</code> (same as variable <code>machine_readable_name</code> in <code>df_NG_biomarker_metadata</code>) which has the biomarker abbreviations in the same format as in the input csv file, the biomarker <code>name</code> which is a bit more descriptive than <code>biomarkerid</code>, and the variables <code>estimate</code>, <code>se</code> and <code>pvalue</code> that correspond to the linear regression coefficient <span class="math inline">\(\beta\)</span>, the standard error and the p-value, respectively.</p>
<div id="forest-plot" class="section level4">
<h4 class="hasAnchor">
<a href="#forest-plot" class="anchor"></a>Forest plot</h4>
<p>Let’s now visualize the results. For the purposes of this demo, we will plot a selected subset of the biomarkers in a forestplot layout. At the end of the tutorial, you will find an example of how to plot associations for all 228 Nightingale biomarkers in a 2-page pdf (see also <code><a href="../articles/ggforestplot.html">vignette("ggforestplot")</a></code> for more details on the usage of <code><a href="../reference/forestplot.html">ggforestplot::forestplot()</a></code>).</p>
<p>The <code>ggforestplot</code> package includes a data frame, called <code><a href="../reference/df_NG_biomarker_metadata.html">ggforestplot::df_NG_biomarker_metadata</a></code>, with metadata on the Nightingale blood biomarkers, such as different naming options, descriptions, group/sugroup information and units of measurement. We will use the group (or sugroup) information in this data frame to decide which groups of biomarkers and in what order we want to visualize here.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Display blood biomarker groups</span>
ggforestplot<span class="op">::</span>df_NG_biomarker_metadata <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">pull</span>(group) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unique">unique</a></span>()
<span class="co">#&gt;  [1] "Cholesterol"                              </span>
<span class="co">#&gt;  [2] "Glycerides and phospholipids"             </span>
<span class="co">#&gt;  [3] "Apolipoproteins"                          </span>
<span class="co">#&gt;  [4] "Fatty acids"                              </span>
<span class="co">#&gt;  [5] "Amino acids"                              </span>
<span class="co">#&gt;  [6] "Glycolysis related metabolites"           </span>
<span class="co">#&gt;  [7] "Ketone bodies"                            </span>
<span class="co">#&gt;  [8] "Fluid balance"                            </span>
<span class="co">#&gt;  [9] "Inflammation"                             </span>
<span class="co">#&gt; [10] "Lipoprotein subclasses"                   </span>
<span class="co">#&gt; [11] "Lipoprotein particle sizes"               </span>
<span class="co">#&gt; [12] "Relative lipoprotein lipid concentrations"</span>

<span class="co"># # You may wish, alternatively, to display blood biomarker subgroups and plot </span>
<span class="co"># # according to that. You can see which subgroups are available in the </span>
<span class="co"># # grouping data by uncommenting the following lines. In several cases, subgroup</span>
<span class="co"># # is identical to group. </span>
<span class="co"># ggforestplot::df_NG_biomarker_metadata %&gt;% </span>
<span class="co">#   pull(subgroup) %&gt;% </span>
<span class="co">#   unique()</span>

<span class="co"># Choose the groups you want to plot and define the order with which group </span>
<span class="co"># categories will appear in the plot</span>
group_order &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(
  <span class="st">"Branched-chain amino acids"</span>,
  <span class="st">"Aromatic amino acids"</span>,
  <span class="st">"Amino acids"</span>,
  <span class="st">"Fluid balance"</span>,
  <span class="st">"Inflammation"</span>,
  <span class="st">"Fatty acids"</span>,
  <span class="st">"Glycerides and phospholipids"</span>,
  <span class="st">"Cholesterol"</span>
)
  
<span class="co"># Extract a subset of the df_NG_biomarker_metadata, with the desired group</span>
<span class="co"># order, to set the order of biomarkers in the forestplot later on</span>
df_with_groups &lt;-<span class="st"> </span>
<span class="st">  </span>ggforestplot<span class="op">::</span>df_NG_biomarker_metadata <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co"># Select subset of variables</span>
<span class="st">  </span><span class="kw">select</span>(<span class="dt">name =</span> name,
         group) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co"># Filter and arrange for the wanted groups</span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(group <span class="op">%in%</span><span class="st"> </span>group_order) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">arrange</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">factor</a></span>(group, <span class="dt">levels =</span> group_order))</code></pre></div>
<div id="statistical-significance-for-multiple-testing" class="section level5">
<h5 class="hasAnchor">
<a href="#statistical-significance-for-multiple-testing" class="anchor"></a>Statistical significance for multiple testing</h5>
<p>We’d also like to add to the forrestplot a Bonferroni correction to account for multiple testing. Here we have a comparison of 228 biomarkers. If we suppose the common significance threshold <span class="math inline">\(\alpha = 0.05\)</span>, the Bonferroni correction for each individual hypothesis, assuming the 228 tests are independent, is <span class="math inline">\(\alpha = 0.05 / 228 \approx 0.0002\)</span>. However, for biologically correlated measures this correction is too strict; Here, instead of correcting for the total number of biomarkers we will use the number of principal components that explain 99% of the variance in the data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Perform principal component analysis on metabolic data</span>
df_pca &lt;-<span class="st"> </span>
<span class="st">  </span>df_full_data <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(Total_C<span class="op">:</span>S_HDL_TG_pct) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="co"># Perform PCA on the data above, after scaling and centering to 0 </span>
    <span class="dt">pca =</span> <span class="kw">map</span>(data, <span class="op">~</span><span class="st"> </span>stats<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/prcomp">prcomp</a></span>(.x, <span class="dt">center =</span> <span class="ot">TRUE</span>, <span class="dt">scale =</span> <span class="ot">TRUE</span>)),
    <span class="co"># Augment the original data with columns containing each observation's </span>
    <span class="co"># projection into the PCA space. Each PCA-space dimension is signified </span>
    <span class="co"># with the .fitted prefix in its name </span>
    <span class="dt">pca_aug =</span> <span class="kw">map2</span>(pca, data, <span class="op">~</span>broom<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/broom/topics/reexports">augment</a></span>(.x, <span class="dt">data =</span> .y))
  )

<span class="co"># Estimate amount of variance explained by each principal component</span>
df_pca_variance &lt;-<span class="st"> </span>
<span class="st">  </span>df_pca <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>(pca_aug) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co"># Estimate variance for the PCA projected variables</span>
<span class="st">  </span><span class="kw">summarize_at</span>(<span class="dt">.vars =</span> <span class="kw">vars</span>(<span class="kw">starts_with</span>(<span class="st">".fittedPC"</span>)), <span class="dt">.funs =</span> <span class="kw">funs</span>(var)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co"># Gather data in a long format </span>
<span class="st">  </span><span class="kw">gather</span>(<span class="dt">key =</span> PC, <span class="dt">value =</span> variance) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co"># Estimate cumulative normalized variance</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">cumvar =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cumsum">cumsum</a></span>(variance <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(variance)),
         <span class="dt">PC =</span> <span class="kw">str_replace</span>(PC, <span class="st">".fitted"</span>, <span class="st">""</span>))

<span class="co"># Find number of principal components that explain 99% </span>
pc_<span class="dv">99</span> &lt;-<span class="st"> </span>
<span class="st">  </span>df_pca_variance <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(cumvar <span class="op">&lt;=</span><span class="st"> </span><span class="fl">0.99</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>()

<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(pc_<span class="dv">99</span>)
<span class="co">#&gt; [1] 49</span></code></pre></div>
<p>Therefore, our significance threshold here will be <span class="math inline">\(\alpha = 0.05 / 49 \approx 0.001\)</span></p>
<p>Below we plot the results. In the forestplot function, our main input is the data frame <code>df_assoc_per_biomarker_bmi</code>, while we use the previously constructed data frame <code>df_with_groups</code> and its variable <code>group</code> to impose the grouping and the order of biomarkers in the plot. For the statistical significance, we input the significance threshold as the parameter <code>psignif = 0.001</code> and we define explicitly the variable name in <code>df_assoc_per_biomarker_bmi</code> that contains the p-values of the linear regression, in this case the column pvalue.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Join the association data frame with group data</span>
df_to_plot &lt;-
<span class="st">  </span>df_assoc_per_biomarker_bmi <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># use right_join, with df_grouping on the right, to preserve the order of </span>
<span class="st">  </span><span class="co"># biomarkers it specifies. </span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">right_join</a></span>(., df_with_groups, <span class="dt">by =</span> <span class="st">"name"</span>) 

<span class="co"># Draw a forestplot of cross-sectional, linear associations.</span>
ggplot_multi &lt;-
<span class="st">  </span>df_to_plot <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">nest</span>(<span class="op">-</span>group, <span class="dt">.key =</span> <span class="st">"data"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># Apply forestplot to each group </span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">gg_groups =</span> purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map2.html">map2</a></span>(
      data, group, <span class="op">~</span><span class="st"> </span><span class="kw"><a href="../reference/forestplot.html">forestplot</a></span>(
        <span class="dt">df =</span> .x,
        <span class="dt">pvalue =</span> pvalue,
        <span class="dt">psignif =</span> <span class="fl">0.001</span>,
        <span class="dt">xlab =</span> <span class="st">"1-SD increment in biomarker concentration</span><span class="ch">\n</span><span class="st">per 1-SD increment in BMI"</span>,
        <span class="dt">title =</span> .y
      ) <span class="op">+</span>
<span class="st">        </span>ggplot2<span class="op">::</span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span>(<span class="dt">xlim =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="op">-</span><span class="fl">0.3</span>, <span class="fl">0.4</span>))
    ),
    <span class="co"># Optional: remove x-axis and legend for all plots except the bottom one</span>
    <span class="dt">gg_groups =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/ifelse">ifelse</a></span>(
      <span class="dt">test =</span> <span class="kw">row_number</span>() <span class="op">!=</span><span class="st"> </span><span class="kw">n</span>(),
      <span class="dt">yes =</span>
        purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(gg_groups, <span class="op">~</span><span class="st"> </span>. <span class="op">+</span>
<span class="st">          </span><span class="kw">theme</span>(
            <span class="dt">axis.text.x =</span> <span class="kw">element_blank</span>(),
            <span class="dt">axis.title.x =</span> <span class="kw">element_blank</span>(),
            <span class="dt">axis.ticks.x =</span> <span class="kw">element_blank</span>(),
            <span class="dt">plot.margin =</span> <span class="kw">unit</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>), <span class="st">"mm"</span>)
          ) <span class="op">+</span>
<span class="st">          </span>ggplot2<span class="op">::</span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="dt">legend.position =</span> <span class="st">"none"</span>)),
      <span class="dt">no =</span> gg_groups
    ),
    <span class="dt">rel_heights =</span> purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(
      data,  <span class="op">~</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(.) 
    ) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unlist">unlist</a></span>()
  )

patchwork<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/patchwork/topics/wrap_plots">wrap_plots</a></span>(
  ggplot_multi<span class="op">$</span>gg_groups,
  <span class="dt">ncol =</span> <span class="dv">1</span>, 
  <span class="dt">heights =</span> ggplot_multi<span class="op">$</span>rel_heights
)</code></pre></div>
<p><img src="nmr-data-analysis-tutorial_files/figure-html/forestplot-1.png" width="672" style="display: block; margin: auto;"></p>
<p>The figure shows that BMI is significantly associated with several of the plotted blood biomarkers. Specifically, higher values of branched chain amino acids, aromatic amino acids omega-6 and glycoprotein acetylation are significantly associated with obesity, as has been previously seen in <a href="https://journals.plos.org/plosmedicine/article?id=10.1371/journal.pmed.1001765">Würtz P et al. Metabolic Signatures of Adiposity in Young Adults: Mendelian Randomization Analysis and Effects of Weight Change., PLoS Med. 2014.</a></p>
</div>
</div>
</div>
<div id="cox-proportional-hazards-regression" class="section level3">
<h3 class="hasAnchor">
<a href="#cox-proportional-hazards-regression" class="anchor"></a>Cox proportional hazards regression</h3>
<p>Similar analysis may be performed for other phenotypic traits. Two other very common regression approaches in epidemiology are logistic regression for studying the association to binary outcomes and Cox proportional hazards for time-to-event outcomes.</p>
<p>In similar spirit as above, we utilize <code><a href="../reference/discovery_regression.html">ggforestplot::discovery_regression()</a></code> to demonstrate an example of fitting Cox proportional hazards in all of the biomarkers to estimate the gender-, age- and BMI- adjusted hazard ratios for type 2 diabetes.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Select only variables to be used for the model and collapse to a long data </span>
<span class="co"># format</span>
df_long &lt;-
<span class="st">  </span>df_full_data <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># Select only model variables</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(nmr_biomarkers, gender, baseline_age, BMI, age_at_diabetes, incident_diabetes) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># log-tranform biomarkers</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_at</a></span>(<span class="dt">.vars =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(nmr_biomarkers), <span class="dt">.funs =</span> dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/funs.html">funs</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">log1p</a></span>(.))) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># Scale biomarkers</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_at</a></span>(<span class="dt">.vars =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(nmr_biomarkers), <span class="dt">.funs =</span> dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/funs.html">funs</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/scale">scale</a></span>(.)))) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># Collapse to a long data format</span>
<span class="st">  </span>tidyr<span class="op">::</span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/gather.html">gather</a></span>(<span class="dt">key =</span> biomarkerid, <span class="dt">value =</span> biomarkervalue, nmr_biomarkers)

<span class="co"># Estimate sex-adjusted associations of metabolite to T2D</span>
<span class="co"># Notice that parameter model below is set to 'coxph'</span>
df_assoc_per_biomarker_diab &lt;-
<span class="st">  </span><span class="kw"><a href="../reference/discovery_regression.html">discovery_regression</a></span>(
    <span class="dt">df_long =</span> df_long, 
    <span class="dt">model =</span> <span class="st">"coxph"</span>,
    <span class="dt">formula =</span>
      <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/formula">formula</a></span>(
        survival<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/survival/topics/Surv">Surv</a></span>(
          <span class="dt">time =</span> baseline_age,
          <span class="dt">time2 =</span> age_at_diabetes,
          <span class="dt">event =</span> incident_diabetes
        ) <span class="op">~</span><span class="st"> </span>biomarkervalue <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">factor</a></span>(gender) <span class="op">+</span><span class="st"> </span>BMI
      ),
    <span class="dt">key =</span> biomarkerid,
    <span class="dt">predictor =</span> biomarkervalue
  ) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co"># Join this dataset with the grouping data in order to choose a different </span>
<span class="st">  </span><span class="co"># biomarker naming option</span>
<span class="st">  </span><span class="kw">left_join</span>(
    <span class="kw">select</span>(
      df_NG_biomarker_metadata, 
      name,
      <span class="dt">biomarkerid =</span> machine_readable_name
    ), 
    <span class="dt">by =</span> <span class="st">"biomarkerid"</span>)

<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(df_assoc_per_biomarker_diab)
<span class="co">#&gt; # A tibble: 6 x 5</span>
<span class="co">#&gt;   biomarkerid estimate     se   pvalue name     </span>
<span class="co">#&gt;   &lt;chr&gt;          &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;    </span>
<span class="co">#&gt; 1 Total_C        0.224 0.0609 2.31e- 4 Total-C  </span>
<span class="co">#&gt; 2 VLDL_C         0.536 0.0651 1.75e-16 VLDL-C   </span>
<span class="co">#&gt; 3 Remnant_C      0.438 0.0654 2.12e-11 Remnant-C</span>
<span class="co">#&gt; 4 LDL_C          0.289 0.0627 3.99e- 6 LDL-C    </span>
<span class="co">#&gt; 5 HDL_C         -0.391 0.0670 5.09e- 9 HDL-C    </span>
<span class="co">#&gt; 6 HDL2_C        -0.433 0.0679 1.86e-10 HDL2-C</span></code></pre></div>
<p>Plot results for fatty acids.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Filter df_NG_biomarker_metadata for only fatty acids</span>
df_grouping &lt;-
<span class="st">  </span>df_NG_biomarker_metadata <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(group <span class="op">%in%</span><span class="st"> "Fatty acids"</span>) 

<span class="co"># Join the association data frame with group data</span>
df &lt;-
<span class="st">  </span>df_assoc_per_biomarker_diab <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># use right_join, with df_grouping on the right, to preserve the order of </span>
<span class="st">  </span><span class="co"># biomarkers it specifies. </span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">right_join</a></span>(., df_grouping, <span class="dt">by =</span> <span class="st">"name"</span>) 

<span class="co"># Draw a forestplot of time-to-event associations for t2d. </span>
ggforestplot<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggforestplot/topics/forestplot">forestplot</a></span>(
  <span class="dt">df =</span> df, 
  <span class="dt">name =</span> name,
  <span class="dt">se =</span> se,
  <span class="dt">pvalue =</span> pvalue,
  <span class="dt">psignif =</span> <span class="fl">0.001</span>,
  <span class="dt">xlab =</span> <span class="st">"Hazards ratio for incident type 2 diabetes (95% CI)</span><span class="ch">\n</span><span class="st">per 1−SD increment in metabolite concentration"</span>,
  <span class="dt">title =</span> <span class="st">"Fatty acids and risk of future T2D"</span>,
  <span class="dt">logodds =</span> <span class="ot">TRUE</span>
) </code></pre></div>
<p><img src="nmr-data-analysis-tutorial_files/figure-html/unnamed-chunk-14-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Notice that the main difference in the latter forestplot as compared to the forestplot for linear associations above, is parameter <code>logodds = TRUE</code>. In this case, the <code>beta</code> values, here log hazard ratios, are exponentiated inside the forestplot to obtain hazard ratios and plotted in a logarithmic scale. The confidence intervals for the odds ratios are estimated using the standard errors of the log hazard ratios, as follows <span class="math inline">\(\text{CI}_\text{low} = \exp(\beta - 0.95 * \text{SE})\)</span> and <span class="math inline">\(\text{CI}_\text{high} = \exp(\beta - 0.95 * \text{SE})\)</span>. If you wish to use some confidence interval other than the default 95%, you may specify this in the parameter <code>ci</code> of the function.</p>
</div>
<div id="a-forestplot-for-all-nightingale-blood-biomarkers" class="section level3">
<h3 class="hasAnchor">
<a href="#a-forestplot-for-all-nightingale-blood-biomarkers" class="anchor"></a>A forestplot for all Nightingale blood biomarkers</h3>
<p>Finally, the <code>ggforestplot</code> package offers a custom function that plots and prints in a 2-page pdf file all Nightingale blood biomarkers, namely <code><a href="../reference/plot_all_NG_biomarkers.html">plot_all_NG_biomarkers()</a></code>. It’s usage is straightforward.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Plot in all biomarkers in a two-page pdf file</span>
<span class="kw"><a href="../reference/plot_all_NG_biomarkers.html">plot_all_NG_biomarkers</a></span>(
  <span class="dt">df =</span> df_assoc_per_biomarker_bmi, 
  <span class="dt">machine_readable_name =</span> biomarkerid,
  <span class="dt">name =</span> name, 
  <span class="dt">beta =</span> beta, 
  <span class="dt">se =</span> se, 
  <span class="dt">pvalue =</span> pvalue, 
  <span class="dt">xlab =</span> <span class="st">"1-SD increment in cardiometabolic trait</span><span class="ch">\n</span><span class="st">per 1-SD increment in biomarker concentration"</span>,
  <span class="dt">filename =</span> <span class="st">"all_ng_associations_bmi.pdf"</span>
)</code></pre></div>
<p>You may view the output of this function <a href="https://github.com/NightingaleHealth/ggforestplot/blob/master/vignettes/figures/all_ng_associations_bmi.pdf">here</a></p>
</div>
</div>
<div id="final-remarks" class="section level2">
<h2 class="hasAnchor">
<a href="#final-remarks" class="anchor"></a>Final remarks</h2>
<p>The purpose of this demo is to familiarize the user with the Nightingale Health biomarker dataset and to showcase simple association analysis using linear and Cox proportional hazards regression.</p>
<p>Further details on data analysis approaches may be found in the following example publications.</p>
</div>
<div id="references" class="section level2">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<ul>
<li><p><a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5988716/">Akbaraly T, et al. Association of circulating metabolites with healthy diet and risk of cardiovascular disease: analysis of two cohort studies. Sci Rep. 2018; 8: 8620</a></p></li>
<li><p><a href="https://www.ncbi.nlm.nih.gov/pubmed/25573147">Würtz P, et al. Metabolite profiling and cardiovascular event risk: a prospective study of 3 population-based cohorts. Circulation. 2015 Mar 3;131(9):774-85.</a></p></li>
<li><p><a href="https://www.sciencedirect.com/science/article/pii/S0735109716003223?via%3Dihub">Würtz P, et al. Metabolomic Profiling of Statin Use and Genetic Inhibition of HMG-CoA Reductase, J Am Coll Cardiol. 2016 Mar 15;67(10):1200-1210</a></p></li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#overview">Overview</a></li>
      <li><a href="#prerequisites">Prerequisites</a></li>
      <li><a href="#overview-of-nightingale-blood-biomarker-data">Overview of Nightingale blood biomarker data</a></li>
      <li><a href="#association-analysis">Association analysis</a></li>
      <li><a href="#final-remarks">Final remarks</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Ilari Scheinin, Maria Kalimeri, Juuso Parkkinen, Emmi Tikkanen, Peter Würtz, Antti Kangas.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
